<!DOCTYPE html>
<html ng-app="webviewPlugin">
<head lang="en">
  <meta charset="UTF-8">
  <title>widget</title>
  <link rel="stylesheet" href="../../../styles/siteIcons.css">

  <script src="../../../scripts/angular/angular.min.js"></script>
  <script type="text/javascript" src="../../../scripts/buildfire.js"></script>
  <style>
    div.link-verified {
      margin: 0;
      position: absolute;
      top: 50%;
      height: 120px;
      margin-top: -75px;
      width: 100%;
    }

    div.link-verified .glyphicon {
      border: 2px solid;
      padding: 10px;
      border-radius: 50%;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="no-scroll" ng-controller="webviewPluginCtrl" ng-cloak>
<div class="scrollable">
  <iframe ng-src="{{ url }}"
          ng-if="(data.content.view == 'Native In App') || data.content.openInApp"
          style="height:100%; width:1px; min-width:100%;"
          scrolling="auto"
          iframe-onload="iframeLoadedCallBack()" id="webviewIframe"></iframe>
</div>
<script>
  var webviewPluginApp = angular.module('webviewPlugin', []);

  webviewPluginApp.directive("iframeOnload", [function () {
    return {
      scope: {
        callBack: '&iframeOnload'
      },
      link: function (scope, element, attrs) {
        element.on('load', function () {
          return scope.callBack();
        });
      }
    }
  }]);

  webviewPluginApp.controller('webviewPluginCtrl', ["$scope", "$sce", function ($scope, $sce) {
    buildfire.spinner.show();

    function dataLoadedHandler(result) {
      var content = null;
      if (result && result.data && !angular.equals({}, result.data)) {
        if (result.data.content) {
          content = result.data.content;
          $scope.data = result.data;
          $scope.url = $sce.trustAsResourceUrl(content.url);
          buildfire.getContext(function (err, context) {
            $scope.isWebPlateform = (context.device.platform == "web");
            if (content.view && content.view != 'Native In App' &&
                content.url) {
              if (context.device.platform != "web") {
                if (content.view == 'In app popup')
                  buildfire.navigation.openWindow(content.url, "_blank");
                else
                  buildfire.navigation.openWindow(content.url, "_system");
                buildfire.navigation.goBack();
              }
              else
                buildfire.navigation.openWindow(content.url, "_blank");
            }
            else if (typeof content.openInApp != 'undefined' && !content.openInApp) {
              buildfire.navigation.openWindow(content.url, "_blank");
            }
            if (!$scope.$$phase && !$scope.$root.$$phase) {
              $scope.$apply();
            }
            buildfire.spinner.hide();
          });
        }
      }
    }

    /*
     * Go pull saved data
     * */
    function loadData() {
      buildfire.datastore.get(function (err, result) {
        if (err) {
          console.error("Error: ", err);
          buildfire.spinner.hide();

        } else {
          dataLoadedHandler(result);
        }
      });
    }


    var history = [];
    var isBackClicked = false;


    buildfire.navigation.onBackButtonClick = function () {

      var oldUrl = history.pop();
      var webviewIframe = document.getElementById("webviewIframe");
      try {
        if (webviewIframe && oldUrl == webviewIframe.contentWindow.location.href)
          oldUrl = history.pop();
      }
      catch (e) {
        console.warn(e);
        // most likely cross domain access failure
      }
      if (webviewIframe && oldUrl) {
        isBackClicked = true;
        webviewIframe.src = oldUrl;
      } else {
        buildfire.navigation.restoreBackButtonClick();
        buildfire.navigation.goBack();
      }
    };

    $scope.iframeLoadedCallBack = function () {
      var webviewIframe = document.getElementById("webviewIframe");
      buildfire.spinner.hide();
      if (!isBackClicked) {
        var oldUrl = webviewIframe.contentWindow.location.href;
        history.push(oldUrl);
      } else
        isBackClicked = false;

      webviewIframe.contentWindow.addEventListener('hashchange', function () {
        if (!isBackClicked) {
          var oldUrl = webviewIframe.contentWindow.location.href;
          history.push(oldUrl);
        } else
          isBackClicked = false;
      });
    };

    loadData();


    /**
     * when a refresh is triggered get reload data
     */
    buildfire.datastore.onRefresh(loadData);

    buildfire.datastore.onUpdate(function (result) {
      dataLoadedHandler(result);
    });
  }]);
</script>
</body>
</html>
